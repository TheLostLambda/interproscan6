# InterProScan6

**!! UNDER DEVELOPMENT !!**

[InterPro](http://www.ebi.ac.uk/interpro/) is a database which integrates together predictive information about proteins’ function from a number of partner resources, giving an overview of the families that a protein belongs to and the domains and sites it contains.

Users who have novel nucleotide or protein sequences that they wish to functionally characterise can use the software package `InterProScan` to run the scanning algorithms from the InterPro database in an integrated way. Sequences are submitted in FASTA format. Matches are then calculated against all of the required member database’s signatures and the results are then output in a variety of formats.

## Requirements

* `Java` (version >= 11)
* `Nextflow` (version >=23.04.02)
* `Docker` (version >= 24.0.5)

## Set up

1. Download member data files:

    curl ftp://ftp.ebi.ac.uk/pub/software/unix/iprscan/5/5.67-99.0/alt/interproscan-data-5.67-99.0.tar.gz \
        --output interproscan-data-5.67-99.0.tar.gz
    tar -pxzf interproscan-data-5.67-99.0.tar.gz
    mv interproscan-5.67-99.0/data .
    rm interproscan-5.67-99.0 -rf
    rm interproscan-data-5.67-99.0.tar.gz


2. Download InterPro data files (xref (entries, goterms and pathways)):

    mkdir i6data
    python interproscan6/files_test/get_data_to_i6.py  # for devs

3. Build a docker `InterProScan6` base image:

    docker build -t interproscan6 .
    
4. Download the additional images we use:
    
    docker pull biocontainers/hmmer:v3.2.1dfsg-1-deb_cv1

5. [Optional] Build a docker image for [`easel`](https://github.com/EddyRivasLab/easel) for the prediction of Open Reading Frames:

    docker build -t easel docker_files/easel

6. [Optional] install licensed software

By default `Phobius`, `SignalP`, and `TMHMM` member database analyses are deactivated in `InterProScan6` 
because they contain licensed components. In order to activate these analyses please see the ['Installing licensed applications'](#installing-licensed-applications-phobius-signalp-tmhmm) documentation.

# Using `InterProScan6`

## Quick start

How to run:

    nextflow run interproscan.nf --input <path to fasta file> [resume]

The results will apear in `result/` folder.  
For debugging, you an find all working files generated by the pipeline in the `work/` dir.

Batchsize parameter in `nextflow.config` defines the number maximum number of sequences submitted within each batch, and thus the quantity of threads of parallelism.

**IMPORTANT:** Change the input params in the `input.yaml` file if you want to test different flows (see in `main.nf`)

An example command to run `InterProScan6`, only using the `AntiFam` member database and `SignalP`, without checking for pre-calculated matches in InterPro (using an example input file):

    nextflow run interproscan.nf --input files_test/best_to_test.fasta --applications signalp,antifam --disable_precalc

## Using DNA sequences

`InterProScan6` takes advantage of the Open Reading Frame (ORF) prediction tool `esl-translate` within the [`easel` tool suite](https://github.com/EddyRivasLab/easel).

The `easel` application itself and all of its dependencies are integrated in InterProScan via a [docker image](#set-up).

### Quick start

Run `InterProScan6` with the `--nucleic` flag

    nextflow run interproscan.nf \
        --input <path to fasta file> \
        --nucleic

By default `InterProScan6` will assume the input FASTA file contains protein sequences. The `--nucleic` flag instructs `InterProScan6` to retrieve all possible ORFs using the `easel` tool suite.

### Configure

You can configure the prediction of ORFs by updating the relevant `translate` parameters in `nextflow.config`:

```groovy
    translate { 
        strand = 'both'  
        methionine = false  
        min_len = 20
        genetic_code = 1
    }
```

* `strand` - DNA strand(s) to be translated
    - `'both'`
    - `'plus'`
    - `'minus'`
* `methionine` - predicted ORFs start with M (methionine)
    - `false` - use initation codon
    - `true` - all ORFs start with M
* `min_len` - minimum length of predicted ORFs [any interger]
* `genetic_code` - ID of the genetic code to use

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Standard</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Vertebrate mitochondrial</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Yeast mitochondrial</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Mold, protozoan, coelenterate mitochondrial; Mycoplasma/Spiroplasma</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Invertebrate mitochondrial</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Ciliate, dasycladacean, Hexamita nuclear</td>
    </tr>
    <tr>
      <td>9</td>
      <td>Echinoderm and flatworm mitochondrial</td>
    </tr>
    <tr>
      <td>10</td>
      <td>Euplotid nuclear</td>
    </tr>
    <tr>
      <td>11</td>
      <td>Bacterial, archaeal; and plant plastid</td>
    </tr>
    <tr>
      <td>12</td>
      <td>Alternative yeast</td>
    </tr>
    <tr>
      <td>13</td>
      <td>Ascidian mitochondrial</td>
    </tr>
    <tr>
      <td>14</td>
      <td>Alternative flatworm mitochondrial</td>
    </tr>
    <tr>
      <td>16</td>
      <td>Chlorophycean mitochondrial</td>
    </tr>
    <tr>
      <td>21</td>
      <td>Trematode mitochondrial</td>
    </tr>
    <tr>
      <td>22</td>
      <td>Scenedesmus obliquus mitochondrial</td>
    </tr>
    <tr>
      <td>23</td>
      <td>Thraustochytrium mitochondrial</td>
    </tr>
    <tr>
      <td>24</td>
      <td>Pterobranchia mitochondrial</td>
    </tr>
    <tr>
      <td>25</td>
      <td>Candidate Division SR1 and Gracilibacteria</td>
    </tr>
  </tbody>
</table>


### Configuration

## Inputs

### Configuration

#### Parameters

`InterProScan6` is configured via the command-line. The only mandatory parameter is `--input`.

**IMPORTANT:** For parameters that have more than one value, separate values using a comma (not spaces) (e.g. `--applications antifam,ncbifam,pfam)`)

**Configuration parameters:**

* `--applications` - a list of member databases/applications to be employed in the analysis. By default, `InterProScan6` employs all member databases and applications, use this flag to run only a subset of applications. For example:

    nextflow run interproscan.nf --input <fasta file> --applications NCBIfam,Panther,Pfam

```yaml
applications: AntiFam,CDD,Coils,FunFam,Gene3d,HAMAP,MobiDBLite,NCBIfam,Panther,Pfam,Phobius,PIRSF,PIRSR,PRINTS,PrositePatterns,PrositeProfiles,SFLD,SignalP_EUK,SignalP_GRAM_NEGATIVE,SignalP_GRAM_POSITIVE,SMART,SuperFamily,TMHMM
```

* `--disable_precalc` - Do not run comparison against an InterPro release to retrive precalculated matches, instead run `interproscan` for all input sequences. [Boolean]
* `--formats` - List output file formats. Supported: JSON,TSV,GFF,XML
* `--goterms` - Whether to retrieve and include Gene Ontology terms from InterPro in the output files. [Boolean]
* `--help` - Whether to disble the help message - `InterProScan6` will not run any analysis when `help` is set to true. [Boolean]
* `--input` - Path to input FASTA file
* `--outfile` - Path and prefix for output files
* `--pathways` - Optional, switch on lookup of corresponding Pathway annotation (IMPLIES - `lookup_file` is defined) [Boolean]
* `--lookup_file` - Lookup of corresponding InterPro annotation in the TSV and GFF3 output formats.

#### Nextflow configuration

Configure the `InterProScan6` utility operations by updating `./nextflow.config`:

* Define the batch size (number of sequences included in each batch job)
* Change the accepted member databases (important if including `SignalP`, `TMHMM` and `Phobius`)
* Update the paths to the InterPro release files

### Sequences

The input sequences to be analysed by `InterProScan6`must be provided in FASTA format. All input sequences must be provided in a multi-sequence FASTA file.

At the moment only protein (amino acid) sequences are supported.

## Outputs

:TODO:

# Installing licensed applications (`Phobius`, `SignalP`, `TMHMM`)

By default `Phobius`, `SignalP`, and `TMHMM` member database analyses are deactivated in `InterProScan6` 
because they contain licensed components. In order to activate these analyses please 
obtain the relevant license and files from the provider (ensuring the software version 
numbers are the same as those supported by your current `InterProScan6` installation).

Files can be placed in any location.

## `SignalP`

### Adding `SignalP` (version 6) to `InterProScan6`

1. Obtain a license and download `SignalP6` (`SignalP` version 6) from the `SignalP6` [server](https://services.healthtech.dtu.dk/services/SignalP-6.0/) (under 'Downloads').
    * Either fast or slow models can be implemented
    * To change the implemented mode please see the [Changing mode](#changing-mode) documentation

2. Unpackage the `SignalP6` `tar` file

    tar -xzf signalp-6.0h.fast.tar.gz -C <SIGNALP-DIR>

3. Copy the docker file available in the `./docker_files/signalp/` directory to your local `SignalP6` directory

```bash
# with the terminal point at the root of this repo
cp docker_files/signalp/Dockerfile <SIGNALP-DIR>/Dockerfile
```

4. Build a docker image - _the Nextflow pipeline needs all third party tools to be stored within linux containers_. 

```bash
# with the terminal pointed at your local signalp dir
docker build -t signalp6 .
```

3. Update the `InterProScan6` configuration: specifically, update `subworkflows/sequence_analysis/members.config`:
```
signalp {
    runner = "signalp"
    data {
        mode = "fast"    <--- UPDATE MODE: fast, slow, or slow-sequential
        model_dir = "$projectDir/bin/signalp/models"  <--- UPDATE PATH TO models DIR
        organism = "other"
    }
}
```

**Note:** _Set `organism` in `nextflow.config` to `"eukaryote"` or `"euk"` to limit the predictions to Sec/SPI, or leave as `"other"` to apply all models in `SignalP6`, as per the `SignalP6` documentation:_

> Specifying the eukarya method of `SignalP6` (`SignalP_EUK`) triggers post-processing of the SP predictions by `SignalP6` to prevent spurious results (only predicts type Sec/SPI).

4. Add `SignalP` to the application list in `nextflow.config`:

params {
    batchsize = 100
    help = false
    applications = 'AntiFam,CDD,Coils,FunFam,Gene3d,HAMAP,MobiDBLite,NCBIfam,Panther,Pfam,PIRSF,PIRSR,PRINTS,PrositePatterns,PrositeProfiles,SFLD,SMART,SuperFamily,SignalP' <--- ADD NEW APPLICATION
    disable_precalc = false
    tsv_pro = false
}

### Running `InterProScan6` with `SignalP6` enabled

Include `signalp` in the list of applications defined using `--applications` flag.

For example:

    nextflow run interproscan.nf --input files_test/best_to_test.fasta --applications signalp --disable_precalc

### Changing mode

`SignalP6` supports 3 modes: `fast`, `slow` and `slow-sequential`. To change the mode of `SignalP6`:

1. Incorporate the new mode into your `SignalP6` installtion as per the `SignalP6` [documentation](https://github.com/fteufel/signalp-6.0/blob/main/installation_instructions.md#installing-additional-modes).

2. Update the `member.config` configuration (`subworkflows/sequence_analysis/members.config`)
```
signalp {
    runner = "signalp"
    data {
        mode = "fast"    <--- UPDATE MODE: fast, slow, or slow-sequential
        model_dir = "$projectDir/bin/signalp/models"
        organism = "other"
    }
}
```

**Note:** _`InterProScan6` only supports the implementation of one `SignalP` mode at a time. A separate `InterProScan6` but be completed for each mode of interest, in order ro apply multiple modes to the same dataset_.

### Converting from CPU to GPU, and back again

:TODO: -- add support for GPU run

The model weights that come with the `SignalP` installation by default run on your CPU.
If you have a GPU available, you can convert your installation to use the GPU instead. 

1. Convert the `SignalP` installation to GPU by following the `SignalP` [documentation](https://github.com/fteufel/signalp-6.0/blob/main/installation_instructions.md#converting-to-gpu)
2. ....???....

# Trouble shooting

## Permission denied

On some systems, Nextflow requires root privileges to be able to create the output directories. 

If you receive an error message such as:
```bash
ERROR ~ Error executing process > 'PARSE_SEQUENCE (1)'

Caused by:
  Unable to create directory=.../InterProScan6/work/56/c74d6bbc6637c201a68afd84b75d27 -- check file system permissions
```

Try running Nextflow with root privileges:
```
sudo nextflow run interproscan.nf --input <path to fasta file> 
```

## File not found

If you recieve a file not found error:
```bash
FileNotFoundError: [Errno 2] No such file or directory
```

This may be due to the docker image not being built correctly. This can happen due to file permissions from preventing docker from reading the `InterProScan6` files.

Try running docker with root privileges:

    sudo docker build -t interproscan6 .


Check the docker installtion is configured correctly, with all necessary privileges. [StackOverflow](https://stackoverflow.com/questions/48957195/how-to-fix-docker-got-permission-denied-issue)

For example, check root privileges have been provided to the docker socket

    sudo chmod 666 /var/run/docker.sock


## Cannot access or failed to open output files for writing

For example:

```bash
Command error:
  
  Error: Failed to open output file hmmer_AntiFam.hmm.out for writing
```

This is most likely a file permission error.

A potential fix is to provide root privilges to the docker contains run by Nextflow in `nextflow.config`:

```groovy
process.container = 'interproscan6'
docker {
    enabled = true
    runOptions = '--user root'
}
```
